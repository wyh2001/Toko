@page "/"
@using Toko.Shared.Models
@using System.Linq
@using Toko.Web.Client.Components
@using Microsoft.AspNetCore.SignalR.Client
@inject HttpClient Http
@inject NavigationManager Navigation
@inject Toko.Web.Client.Services.IAuthenticationService AuthService
@inject Toko.Web.Client.Services.IPlayerNameService PlayerNameService
@implements IDisposable
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Toko Toko</PageTitle>

@* <h1>Test the blazor</h1> *@
<div class="container">
    <div class="header">
        <h1 class="main-title">Toko Toko</h1>
        <p class="subtitle">Strategic Programming Board Game</p>
    </div>

    <div class="main-grid">
        <!-- Create Game - Primary Action -->
        <div class="tile create-tile" @onclick="CreateGame">
            <div class="create-number">01</div>
            <div class="create-text">NEW GAME</div>
            <div class="create-subtitle">Initialize Racing Session</div>
        </div>

        <!-- Open Rooms -->
        <div class="tile data-tile rooms-tile" onclick="location.href='#rooms-section'">
            <div class="data-number">@(waitingCount?.ToString("D2") ?? "...")</div>
            <div class="data-text">Open Rooms</div>
            <div class="data-subtitle">Available Sessions</div>
        </div>

        <!-- Players Online -->
        <div class="tile data-tile players-tile">
            <div class="data-number">@(playingRacersCount?.ToString("D2") ?? "...")</div>
            <div class="data-text">Online</div>
            <div class="data-subtitle">Players Racing</div>
        </div>

        <!-- How to Play -->
        <div class="tile text-tile guide-tile" @onclick="ShowHowToPlay">
            <div class="text-title">How to Play</div>
            <div class="text-subtitle">Strategic Racing Mechanics and Rules</div>
        </div>

        <!-- About -->
        <div class="tile text-tile about-tile" @onclick="ShowAbout">
            <div class="text-title">About</div>
            <div class="text-subtitle">Game Information</div>
        </div>

        <!-- Recent Games -->
        <div class="tile data-tile games-tile">
            <div class="data-number">@(finishedCount?.ToString("D2") ?? "...")</div>
            <div class="data-text">Games Today</div>
            <div class="data-subtitle">Completed Sessions</div>
        </div>

        <!-- System Status -->
        <div class="tile text-tile status-tile" @onclick="ShowStatus">
            <div class="text-title">System Status</div>
            <div class="text-subtitle">@(isApiOnline && isSignalROnline ? "All Services Operational" : "Some Services Unavailable")</div>
        </div>
    </div>

    <div class="rooms-section" id="rooms-section">
        <h2 class="section-title">Open Rooms</h2>
        <div class="room-list">
            @if (rooms == null)
            {
                <div class="loading-message">Loading Rooms...</div>
            }
            else if (rooms.Count == 0)
            {
                <div class="no-rooms-message">No Active Sessions</div>
            }
            else
            {            @foreach (var room in rooms)
            {
                <RoomCard Room="room" />
            }
            }
        </div>
    </div>
</div>

<CreateGameModal IsVisible="showCreateGameModal"
                 OnClose="CloseCreateGameModal"
                 OnGameCreated="HandleGameCreated"
                 PlayerNameService="PlayerNameService" />

<HowToPlayModal IsVisible="showHowToPlayModal" OnClose="CloseHowToPlayModal" />
<AboutModal IsVisible="showAboutModal" OnClose="CloseAboutModal" />
<StatusModal IsVisible="showStatusModal"
             OnClose="CloseStatusModal"
             PlayersOnline="playingRacersCount"
             GamesInProgress="playingCount"
             GamesToday="finishedCount"
             OpenRooms="waitingCount"
             IsApiOnline="isApiOnline"
             IsSignalROnline="isSignalROnline" />

@code{
    private Timer? pollingTimer;
    private long? waitingCount;
    private long? playingCount;
    private long? finishedCount;
    private long? playingRacersCount;
    private List<RoomListItemDto>? rooms;
    
    private bool showCreateGameModal = false;
    private bool showHowToPlayModal = false;
    private bool showAboutModal = false;
    private bool showStatusModal = false;
    private bool isApiOnline = false;
    private bool isSignalROnline = false;

    protected override void OnInitialized()
    {
        pollingTimer = new Timer(
            callback: async _ => await FetchData(),
            state: null,
            dueTime: TimeSpan.Zero,
            period: TimeSpan.FromSeconds(30)
        );
    }

    private async Task CreateGame()
    {
        // Ensure we're authenticated before allowing game creation
        var isAuthenticated = await AuthService.EnsureAuthenticatedAsync();
        if (isAuthenticated)
        {
            showCreateGameModal = true;
        }
        else
        {
            Console.WriteLine("Cannot create game - authentication failed");
        }
    }

    private void CloseCreateGameModal()
    {
        showCreateGameModal = false;
    }

    private void ShowHowToPlay()
    {
        showHowToPlayModal = true;
    }

    private void CloseHowToPlayModal()
    {
        showHowToPlayModal = false;
    }

    private void ShowAbout()
    {
        showAboutModal = true;
    }

    private void CloseAboutModal()
    {
        showAboutModal = false;
    }

    private async Task ShowStatus()
    {
        showStatusModal = true;
        await CheckApiHealth();
    }

    private async Task CheckApiHealth()
    {
        // Check API
        var apiTask = CheckApi();
        // Check SignalR
        var signalRTask = CheckSignalR();

        await Task.WhenAll(apiTask, signalRTask);
        await InvokeAsync(StateHasChanged);
    }

    private async Task CheckApi()
    {
        using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(3));
        try
        {
            var response = await Http.GetAsync("api/room/room-counts", cts.Token);
            isApiOnline = response.IsSuccessStatusCode;
        }
        catch
        {
            isApiOnline = false;
        }
    }

    private async Task CheckSignalR()
    {
        HubConnection? hubConnection = null;
        using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(3));
        try
        {
            var hubUrl = Navigation.ToAbsoluteUri("/raceHub").ToString();
            hubConnection = new HubConnectionBuilder()
                .WithUrl(hubUrl)
                .Build();

            await hubConnection.StartAsync(cts.Token);
            isSignalROnline = hubConnection.State == HubConnectionState.Connected;
        }
        catch
        {
            isSignalROnline = false;
        }
        finally
        {
            if (hubConnection != null)
            {
                await hubConnection.DisposeAsync();
            }
        }
    }

    private void CloseStatusModal()
    {
        showStatusModal = false;
    }

    private void HandleGameCreated(CreateRoomDto gameData)
    {
        Console.WriteLine($"Game created: {gameData.RoomId}");
        // Navigate to the created room
        Navigation.NavigateTo($"/room/{gameData.RoomId}");
    }

    private async Task FetchData()
    {
        try
        {
            var client = Http;

            // Fetch room counts
            var countsResponse = await client.GetFromJsonAsync<ApiSuccess<RoomCountsDto>>("api/room/room-counts");
            if (countsResponse is not null && countsResponse.Data is not null)
            {
                playingCount = countsResponse.Data.PlayingCount;
                playingRacersCount = countsResponse.Data.PlayingRacersCount;
                finishedCount = countsResponse.Data.FinishedCount;
            }

            // Fetch room list
            var roomsResponse = await client.GetFromJsonAsync<ApiSuccess<List<RoomListItemDto>>>("api/room/list");
            if (roomsResponse is not null && roomsResponse.Data is not null)
            {
                rooms = roomsResponse.Data;
                waitingCount = rooms.Count(r => !r.IsPrivate && r.Status == "Waiting");
            }

            isApiOnline = true;

            // Notify the UI to update
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to fetch data: {ex.Message}");
            isApiOnline = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        pollingTimer?.Dispose();
    }
}
