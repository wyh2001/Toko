@page "/"
@using Toko.Shared.Models
@using System.Linq
@using Toko.Web.Client.Components
@inject HttpClient Http
@inject NavigationManager Navigation
@inject Toko.Web.Client.Services.IAuthenticationService AuthService
@inject Toko.Web.Client.Services.IPlayerNameService PlayerNameService
@implements IDisposable
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Toko Toko</PageTitle>

@* <h1>Test the blazor</h1> *@
<div class="container">
    <div class="header">
        <h1 class="main-title">Toko Toko</h1>
        <p class="subtitle">Strategic Programming Board Game</p>
    </div>

    <div class="main-grid">
        <!-- Create Game - Primary Action -->
        <div class="tile create-tile" @onclick="CreateGame">
            <div class="create-number">01</div>
            <div class="create-text">NEW GAME</div>
            <div class="create-subtitle">Initialize Racing Session</div>
        </div>

        <!-- Open Rooms -->
        <div class="tile data-tile rooms-tile" onclick="location.href='#rooms-section'">
            <div class="data-number">@(waitingCount?.ToString("D2") ?? "...")</div>
            <div class="data-text">Open Rooms</div>
            <div class="data-subtitle">Available Sessions</div>
        </div>

        <!-- Players Online -->
        <div class="tile data-tile players-tile">
            <div class="data-number">@(playingRacersCount?.ToString("D2") ?? "...")</div>
            <div class="data-text">Online</div>
            <div class="data-subtitle">Players Racing</div>
        </div>

        <!-- How to Play -->
        <div class="tile text-tile guide-tile" onclick="showGuide()">
            <div class="text-title">How to Play</div>
            <div class="text-subtitle">Strategic Racing Mechanics and Rules</div>
        </div>

        <!-- About -->
        <div class="tile text-tile about-tile" onclick="showAbout()">
            <div class="text-title">About</div>
            <div class="text-subtitle">Game Information</div>
        </div>

        <!-- Recent Games -->
        <div class="tile data-tile games-tile">
            <div class="data-number">@(finishedCount?.ToString("D2") ?? "...")</div>
            <div class="data-text">Games Today</div>
            <div class="data-subtitle">Completed Sessions</div>
        </div>

        <!-- System Status -->
        <div class="tile text-tile status-tile" onclick="showStatus()">
            <div class="text-title">System Status</div>
            <div class="text-subtitle">All Racing Servers Operational</div>
        </div>
    </div>

    <div class="rooms-section" id="rooms-section">
        <h2 class="section-title">Open Rooms</h2>
        <div class="room-list">
            @if (rooms == null)
            {
                <div class="loading-message">Loading Rooms...</div>
            }
            else if (rooms.Count == 0)
            {
                <div class="no-rooms-message">No Active Sessions</div>
            }
            else
            {            @foreach (var room in rooms)
            {
                <RoomCard Room="room" />
            }
            }
        </div>
    </div>
</div>

<CreateGameModal IsVisible="showCreateGameModal" 
                 OnClose="CloseCreateGameModal" 
                 OnGameCreated="HandleGameCreated"
                 PlayerNameService="PlayerNameService" />

@code{
    private Timer? pollingTimer;
    private long? waitingCount;
    private long? playingCount;
    private long? finishedCount;
    private long? playingRacersCount;
    private List<RoomListItemDto>? rooms;
    
    private bool showCreateGameModal = false;

    protected override void OnInitialized()
    {
        pollingTimer = new Timer(
            callback: async _ => await FetchData(),
            state: null,
            dueTime: TimeSpan.Zero,
            period: TimeSpan.FromSeconds(30)
        );
    }

    private async Task CreateGame()
    {
        // Ensure we're authenticated before allowing game creation
        var isAuthenticated = await AuthService.EnsureAuthenticatedAsync();
        if (isAuthenticated)
        {
            showCreateGameModal = true;
        }
        else
        {
            Console.WriteLine("Cannot create game - authentication failed");
        }
    }

    private void CloseCreateGameModal()
    {
        showCreateGameModal = false;
    }

    private void HandleGameCreated(CreateRoomDto gameData)
    {
        Console.WriteLine($"Game created: {gameData.RoomId}");
        // Navigate to the created room
        Navigation.NavigateTo($"/room/{gameData.RoomId}");
    }

    private async Task FetchData()
    {
        try
        {
            var client = Http;
            
            // Fetch room counts
            var countsResponse = await client.GetFromJsonAsync<ApiSuccess<RoomCountsDto>>("api/room/room-counts");
            if (countsResponse is not null && countsResponse.Data is not null)
            {
                playingCount = countsResponse.Data.PlayingCount;
                playingRacersCount = countsResponse.Data.PlayingRacersCount;
                finishedCount = countsResponse.Data.FinishedCount;
            }

            // Fetch room list
            var roomsResponse = await client.GetFromJsonAsync<ApiSuccess<List<RoomListItemDto>>>("api/room/list");
            if (roomsResponse is not null && roomsResponse.Data is not null)
            {
                rooms = roomsResponse.Data;
                waitingCount = rooms.Count(r => !r.IsPrivate && r.Status == "Waiting");
            }

            // Notify the UI to update
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to fetch data: {ex.Message}");
        }
    }

    public void Dispose()
    {
        pollingTimer?.Dispose();
    }
}
