@page "/game/{roomId}"
@using Toko.Shared.Models
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Toko.Web.Client.Services
@using System.Net.Http.Json
@implements IAsyncDisposable
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@* @rendermode InteractiveWebAssembly *@

<PageTitle>Game - @roomName - Toko Toko</PageTitle>

<div class="game-container">
    <!-- Connection Status -->
    @if (!isConnected)
    {
        <div class="connection-status-overlay disconnected">
            <div class="status-icon">‚ùå</div>
            <div class="status-text">Disconnected. Please refresh the page.</div>
        </div>
    }
    else if (isReconnecting)
    {
        <div class="connection-status-overlay reconnecting">
            <div class="status-icon">üîÑ</div>
            <div class="status-text">Connection lost. Reconnecting...</div>
        </div>
    }

    <!-- Game Header -->
    <div class="game-header">
        <div class="game-title-section">
            <h1 class="game-title">@roomName</h1>
            <div class="game-subtitle">Racing Session ‚Ä¢ Round @DisplayedRound / @(gameData?.TotalRounds ?? 0)</div>
        </div>
        <div class="game-controls">
            <button class="control-button" @onclick="ShowGameMenu">‚â° Menu</button>
            <button class="control-button danger" @onclick="LeaveGame">‚Üê Leave Game</button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-section">
            <div class="loading-message">Loading Game...</div>
        </div>
    }
    else if (gameData == null)
    {
        @if (gameEnded)
        {
            <div class="game-ended-section">
                <div class="game-ended-message">üèÅ Game Finished</div>
                <div class="game-ended-subtitle">The race has ended! Check the final results.</div>
                <div class="game-ended-actions">
                    <button class="action-button primary" @onclick="ViewRoom">View Room</button>
                    <button class="action-button secondary" @onclick="GoHome">Return Home</button>
                </div>
            </div>
        }
        else
        {
            <div class="error-section">
                <div class="error-message">Game Not Found</div>
                <div class="error-subtitle">The game may have ended or does not exist</div>
                <button class="action-button primary" @onclick="GoHome">Return Home</button>
            </div>
        }
    }
    else
    {
        @if (showGameEndedOverlay)
        {
            <!-- Game Ended State -->
            <div class="game-ended-overlay">
                <div class="game-ended-content">
                    <h2>RACE FINISHED</h2>
                    <div class="final-results">
                        <h3>Final Results</h3>
                        @if (gameData?.Results != null && gameData.Results.Any())
                        {
                            <div class="results-list">
                                @foreach (var result in gameData.Results.OrderBy(r => r.Rank))
                                {
                                    <div class="result-item @(result.PlayerId == AuthService.PlayerId ? "current-player" : "")">
                                        <div class="result-position">#{@result.Rank}</div>
                                        <div class="result-name">@GetPlayerNameSafe(result.PlayerId).ToUpper()</div>
                                        <div class="result-score">@result.Score PTS</div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="no-results-message">
                                <p>Results are being calculated...</p>
                            </div>
                        }
                    </div>
                    <div class="game-ended-actions">
                        <button class="action-button primary" @onclick="ViewRoom">View Room</button>
                        <button class="action-button secondary" @onclick="ReviewGame">Review Game</button>
                        <button class="action-button secondary" @onclick="GoHome">Return Home</button>
                    </div>
                </div>
            </div>
        }
        
        <!-- Main Game Layout -->
        <div class="game-layout">
            <!-- Left Panel - Players and Status -->
            <div class="left-panel">
                <!-- Game Status -->
                <div class="status-section">
                    <h3 class="panel-title">Game Status</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-number">@DisplayedRound / @(gameData?.TotalRounds ?? 0)</div>
                            <div class="status-label">Round</div>
                        </div>
                        <div class="status-item">
                            <div class="status-number">@((gameData?.CurrentStep ?? 0) + 1) / @(gameData?.TotalSteps ?? 0)</div>
                            <div class="status-label">Step</div>
                        </div>
                        <div class="status-item">
                            <div class="status-number">@(gameData?.Racers?.Count ?? 0)</div>
                            <div class="status-label">Players</div>
                        </div>
                        <div class="status-item">
                            <div class="status-text">@gamePhaseString</div>
                            <div class="status-label">Phase</div>
                        </div>
                    </div>
                </div>

                <!-- Turn Order -->
                <div class="turn-order-section">
                    <h3 class="panel-title">Turn Order</h3>
                    <div class="turn-order-list">
                        @if (gameData?.TurnOrder != null)
                        {
                            @for (int i = 0; i < gameData.TurnOrder.Count; i++)
                            {
                                var turnPlayer = gameData.TurnOrder[i];
                                <div class="turn-order-item @(turnPlayer.PlayerId == AuthService.PlayerId ? "current-player" : "") @(currentTurnPlayer == turnPlayer.PlayerId ? "active-turn" : "")">
                                    <div class="turn-order-position">@(i + 1)</div>
                                    <div class="turn-order-info">
                                        <div class="turn-order-name">@turnPlayer.PlayerName.ToUpper()</div>
                                        <div class="gear-shift-indicator">
                                            @for (int j = 0; j < turnPlayer.GearShiftCount; j++)
                                            {
                                                <span class="gear-shift-icon">‚öô</span>
                                            }
                                            @if (turnPlayer.GearShiftCount == 0)
                                            {
                                                <span class="no-shifts">-</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Players List -->
                <div class="players-section">
                    <h3 class="panel-title">Racers</h3>
                    <div class="players-list">
                        @if (gameData?.Racers != null)
                        {
                            @foreach (var player in gameData.Racers)
                            {
                            <div class="player-item @(player.Id == AuthService.PlayerId ? "current-player" : "") @(currentTurnPlayer == player.Id ? "active-turn" : "")">
                                <div class="player-info">
                                    <div class="player-main-line">
                                        <div class="player-name">@player.Name.ToUpper()</div>
                                        <div class="player-status">
                                            @if (currentTurnPlayer == player.Id)
                                            {
                                                <div class="turn-indicator">‚óè</div>
                                            }
                                            @if (player.IsHost)
                                            {
                                                <div class="host-badge">HOST</div>
                                            }
                                        </div>
                                    </div>
                                    <div class="player-stats">
                                        <div class="player-position">Position @GetPlayerPosition(player.Id)</div>
                                        <div class="player-gear">G @GetPlayerGear(player.Id)</div>
                                        <div class="player-timebank">@GetPlayerTimeBankDisplay(player.Id)</div>
                                    </div>
                                </div>
                            </div>
                            }
                        }
                    </div>
                </div>

                <!-- Game Log -->
                <div class="log-section">
                    <h3 class="panel-title">Game Log</h3>
                    <div class="log-container">
                        @if (gameLogs.Any())
                        {
                            @foreach (var logEntry in gameLogs.TakeLast(5).Reverse())
                            {
                                <div class="log-entry @(logEntry.PlayerId == AuthService.PlayerId ? "current-player-log" : "")">
                                    <div class="log-time">R@(logEntry.Round+1)-S@(logEntry.Step+1)</div>
                                    <div class="log-message">@logEntry.Message</div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="log-entry empty-log">
                                <div class="log-message">Logs will appear here when available.</div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Center Panel - Game Board -->
            <div class="center-panel">
                <div class="board-section">
                    <h3 class="panel-title">Race Track</h3>
                    <div class="race-board-container">
                        @if (gameData?.Map != null)
                        {
                            <RaceBoard MapSnapshot="@gameData.Map" RoomStatus="@gameData" TileSize="96"></RaceBoard>
                        }
                        else
                        {
                            <div class="error-message">Map data is not available.</div>
                        }
                    </div>
                </div>
            </div>

            <!-- Right Panel - Hand and Actions -->
            <div class="right-panel">
                <!-- Current Hand -->
                <div class="hand-section">
                    <h3 class="panel-title">Your Hand (@playerHand.Count cards)</h3>
                    <div class="card-hand">
                        @foreach (var card in playerHand)
                        {
                            <div class="game-card @(GetCardSelectionClass(card))" 
                                 @onclick="() => HandleCardClick(card)">
                                <div class="card-type">@card.Type</div>
                                <div class="card-value">@GetCardValue(card.Type)</div>
                                @if (ShouldShowCardDisabledOverlay(card))
                                {
                                    <div class="card-disabled-overlay">
                                        <span>@GetCardDisabledMessage(card)</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>

                <!-- Action Panel -->
                <div class="action-section">
                    <h3 class="panel-title">Actions</h3>
                    <div class="action-buttons">
                        @if (isMyTurn)
                        {
                            @if (gamePhase == Phase.CollectingCards)
                            {
                                <button class="action-button primary @(string.IsNullOrEmpty(selectedCard) ? "disabled" : "")"
                                        @onclick="PlaySelectedCard"
                                        disabled="@(string.IsNullOrEmpty(selectedCard))">
                                    Submit Card
                                </button>
                                <button class="action-button secondary" @onclick="DrawCards">
                                    Draw Cards
                                </button>
                            }
                            else if (gamePhase == Phase.CollectingParams)
                            {
                                <!-- Parameter Collection UI -->
                                <div class="param-collection-section">
                                    <div class="param-info">
                                        <strong>Card Type:</strong> @(gameData?.CurrentTurnCardType ?? "Unknown")
                                    </div>
                                    
                                    @if (gameData?.CurrentTurnCardType == "ChangeLane")
                                    {
                                        <div class="param-input">
                                            <label>Lane Direction:</label>
                                            @{
                                                var (laneButtons, layoutClass) = GetLaneChangeButtonsAndLayout();
                                            }
                                            <div class="effect-buttons @layoutClass">
                                                @foreach (var button in laneButtons)
                                                {
                                                    <button class="effect-button @(changeLaneEffect == button.Value ? "selected" : "")" 
                                                            @onclick="() => SetChangeLaneEffect(button.Value)">@button.Text</button>
                                                }
                                            </div>
                                        </div>
                                    }
                                    else if (gameData?.CurrentTurnCardType == "ShiftGear")
                                    {
                                        <div class="param-input">
                                            <label>Gear Change:</label>
                                            <div class="effect-buttons">
                                                <button class="effect-button shift-down @(shiftGearEffect == -1 ? "selected" : "")" 
                                                        @onclick="() => SetShiftGearEffect(-1)">DOWN</button>
                                                <button class="effect-button shift-up @(shiftGearEffect == 1 ? "selected" : "")" 
                                                        @onclick="() => SetShiftGearEffect(1)">UP</button>
                                            </div>
                                        </div>
                                    }
                                    else if (gameData?.CurrentTurnCardType == "Repair")
                                    {
                                        <div class="param-input">
                                            <label>Select Junk Cards to Discard:</label>
                                            <div class="repair-instruction">
                                                Click on Junk cards in your hand above to select them for discarding.
                                            </div>
                                        </div>
                                    }
                                    
                                    <button class="action-button primary @(IsParameterSubmissionReady() ? "" : "disabled")"
                                            @onclick="SubmitParameters"
                                            disabled="@(!IsParameterSubmissionReady())">
                                        @(gameData?.CurrentTurnCardType == "Repair" && junkCards.Count == 0 ? "Skip" : "Submit Parameters")
                                    </button>
                                </div>
                            }
                        }
                        
                        @if (gamePhase == Phase.Discarding)
                        {
                            <!-- Discarding Phase UI - Independent of turn order -->
                            <div class="discard-phase-section">
                                <div class="discard-info">
                                    <strong>Discarding Phase</strong>
                                    <p>Click on cards in your hand to select them for discarding (Junk cards cannot be discarded)</p>
                                </div>
                                
                                @if (IsPlayerInDiscardPhase())
                                {
                                    <div class="discard-actions">
                                        <button class="action-button primary @(HasJunkCardsSelected() ? "disabled" : "")" 
                                                @onclick="SubmitDiscardCards"
                                                disabled="@HasJunkCardsSelected()">
                                            Discard Selected Cards (@selectedDiscardCards.Count)
                                        </button>
                                        <button class="action-button secondary" @onclick="SkipDiscard">
                                            Skip Discarding@(discardCountdown > 0 ? $" ({discardCountdown}s)" : "")
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="waiting-discard-message">
                                        <div class="waiting-message">
                                            Waiting for other players to discard...
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else if (!isMyTurn)
                        {
                            <div class="waiting-message">
                                Waiting for @GetPlayerName(currentTurnPlayer)...
                            </div>
                        }
                    </div>
                </div>

                <!-- Game Instructions -->
                <div class="instructions-section">
                    <h3 class="panel-title">Instructions</h3>
                    <div class="instructions-content">
                        @if (gamePhase == Phase.CollectingCards)
                        {
                            <p>Select a card to program your action. After executing your card, you'll automatically move forward based on your current gear.</p>
                            <div class="gear-info">
                                <small>Current gear: @GetPlayerGear(AuthService.PlayerId ?? "") (moves @GetPlayerGear(AuthService.PlayerId ?? "") spaces after actions)</small>
                            </div>
                        }
                        else if (gamePhase == Phase.CollectingParams)
                        {
                            @if (gameData?.CurrentTurnCardType == "ChangeLane")
                            {
                                <p>Choose which direction to change lanes (Left or Right).</p>
                            }
                            else if (gameData?.CurrentTurnCardType == "ShiftGear")
                            {
                                <p>Choose whether to shift up or down a gear. Higher gears allow faster movement.</p>
                            }
                            else if (gameData?.CurrentTurnCardType == "Repair")
                            {
                                <p>Click on Junk cards in your hand above to select them for discarding. You can select none to skip.</p>
                            }
                            else
                            {
                                <p>Submit parameters for your selected card.</p>
                            }
                        }
                        else if (gamePhase == Phase.Discarding)
                        {
                            @if (IsPlayerInDiscardPhase())
                            {
                                <p>Click on cards in your hand to select them for discarding. Junk cards cannot be discarded and will be grayed out.</p>
                            }
                            else
                            {
                                <p>Waiting for other players to finish discarding cards...</p>
                            }
                        }
                        else
                        {
                            <p>Waiting for game to start...</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>
